{{ if eq .chezmoi.os "linux" -}}
{{- $osid := .chezmoi.os -}}
{{- if hasKey .chezmoi.osRelease "id" -}}
{{-   $osid = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
{{- end -}}
{{- $base_packages := "tmux atuin starship ack eza bat direnv fastfetch fish httpie wget rsync pinentry-tty btop fd-find ripgrep zoxide neovim" -}}
{{- $arch_packages := replace (replace $base_packages "fd-find" "fd") "pinentry-tty" "pinentry" -}}
#!/bin/sh
set -e

echo "Installing packages for Linux ({{ $osid }})..."

{{ if eq $osid "linux-debian" -}}
# Debian
echo "Updating package lists..."
sudo apt update
echo "Installing packages: {{ $base_packages }}"
sudo apt install -y {{ $base_packages }}
{{ else if eq $osid "linux-ubuntu" -}}
# Ubuntu
echo "Updating package lists..."
sudo apt update
echo "Installing packages: {{ $base_packages }}"
sudo apt install -y {{ $base_packages }}
{{ else if eq $osid "linux-arch" -}}
# Arch Linux
echo "Updating system and installing packages: {{ $arch_packages }}"
sudo pacman -Syu --noconfirm {{ $arch_packages }}
{{ else -}}
echo "Unsupported Linux distribution: {{ $osid }}"
echo "Please install the following packages manually: {{ $base_packages }}"
exit 1
{{ end -}}

{{ else if eq .chezmoi.os "darwin" -}}
#!/bin/sh
set -e

echo "Installing packages for macOS..."

# Install Homebrew if not already installed
if [ ! -x "$(command -v brew)" ]; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
else
    echo "Homebrew already installed, updating..."
    brew update
fi

# Install packages from Brewfile
echo "Installing packages from Brewfile..."
brew bundle

# Install terminal and window management tools
echo "Installing terminal and window management tools..."
if [ -d "/Applications/Hammerspoon.app" ]; then
    echo "Hammerspoon already installed, skipping..."
elif brew list --cask hammerspoon &> /dev/null; then
    echo "Hammerspoon already installed via Homebrew, skipping..."
else
    echo "Installing Hammerspoon..."
    brew install --cask hammerspoon
fi

if [ -d "/Applications/Karabiner-Elements.app" ]; then
    echo "Karabiner-Elements already installed, skipping..."
elif brew list --cask karabiner-elements &> /dev/null; then
    echo "Karabiner-Elements already installed via Homebrew, skipping..."
else
    echo "Installing Karabiner-Elements..."
    brew install --cask karabiner-elements
fi

# Install fonts
echo "Installing fonts..."
for font in font-fira-mono-nerd-font font-fira-code-nerd-font font-fira-code font-fira-mono; do
    if ! brew list --cask "$font" &> /dev/null; then
        echo "Installing $font..."
        brew install "$font"
    else
        echo "$font already installed, skipping..."
    fi
done

{{ else if eq .chezmoi.os "windows" -}}
#!/bin/sh
echo "Windows not supported"
exit 1
{{ else -}}
#!/bin/sh
echo "Unsupported OS: {{ .chezmoi.os }}"
exit 1
{{ end -}}

echo "Package installation completed successfully!"