# Codex default command policy rules (Starlark).
#
# Goals:
# - Allow common read-only/dev commands without prompting.
# - Prompt on destructive or history/remote-changing operations.
# - Avoid overly-specific `match=` strings that miss real commands.

# --- GitHub CLI (read-only) ---
prefix_rule(pattern=["gh", "run", "list"], decision="allow")
prefix_rule(pattern=["gh", "run", "view"], decision="allow")
prefix_rule(pattern=["gh", "run", "watch"], decision="allow")

# --- Task runner (safe build/test/lint) ---
prefix_rule(pattern=["task", "build"], decision="allow")
prefix_rule(pattern=["task", "build-ci"], decision="allow")
prefix_rule(pattern=["task", "lint-check"], decision="allow")
prefix_rule(pattern=["task", "test"], decision="allow")

# --- Python/uv ---
prefix_rule(pattern=["uv", "run", "pytest"], decision="allow")
prefix_rule(pattern=["uv", "sync"], decision="allow")

# --- Wails ---
prefix_rule(pattern=["wails", "build"], decision="allow")
prefix_rule(pattern=["wails", "dev"], decision="allow")

# --- Codex skill installer scripts (scoped) ---
prefix_rule(
  pattern=["python3", "/Users/shrike/.codex/skills/.system/skill-installer/scripts/list-curated-skills.py"],
  decision="allow",
)
prefix_rule(
  pattern=["python3", "/Users/shrike/.codex/skills/.system/skill-installer/scripts/install-skill-from-github.py"],
  decision="allow",
)

# --- Common read-only shell commands ---
prefix_rule(pattern=["ls"], decision="allow")
prefix_rule(pattern=["cat"], decision="allow")
prefix_rule(pattern=["sed"], decision="allow")
prefix_rule(pattern=["awk"], decision="allow")
prefix_rule(pattern=["rg"], decision="allow")
prefix_rule(pattern=["fd"], decision="allow")
prefix_rule(pattern=["find"], decision="allow")
prefix_rule(pattern=["stat"], decision="allow")
prefix_rule(pattern=["file"], decision="allow")
prefix_rule(pattern=["head"], decision="allow")
prefix_rule(pattern=["tail"], decision="allow")
prefix_rule(pattern=["wc"], decision="allow")

# --- Git: allow safe/local inspection & non-destructive ops ---
prefix_rule(pattern=["git", "status"], decision="allow")
prefix_rule(pattern=["git", "diff"], decision="allow")
prefix_rule(pattern=["git", "log"], decision="allow")
prefix_rule(pattern=["git", "show"], decision="allow")
prefix_rule(pattern=["git", "branch"], decision="allow")
prefix_rule(pattern=["git", "rev-parse"], decision="allow")
prefix_rule(pattern=["git", "fetch"], decision="allow")
prefix_rule(pattern=["git", "pull"], decision="allow")
prefix_rule(pattern=["git", "checkout"], decision="allow")
prefix_rule(pattern=["git", "switch"], decision="allow")
prefix_rule(pattern=["git", "restore"], decision="allow")

# Allow staging by default (not destructive by itself).
prefix_rule(pattern=["git", "add"], decision="allow")

# Submodules are common; keep them allowed if you use them.
prefix_rule(pattern=["git", "submodule"], decision="allow")

# --- Prompt: destructive file operations ---
# rm is only dangerous when recursive/force/glob-y. Prompt on those.
# Allow plain single-file rm (no -r/-f) without prompting.
prefix_rule(
  pattern=["rm"],
  decision="prompt",
  match=[" rm -r", " rm -rf", " rm -fr", " rm -f", " rm --recursive", " rm --force"],
)

# Prompt on moves/renames (can be destructive). If you prefer to allow mv by default, delete this.
prefix_rule(pattern=["mv"], decision="prompt")

# Prompt on chmod/chown in case an agent breaks permissions.
prefix_rule(pattern=["chmod"], decision="prompt")
prefix_rule(pattern=["chown"], decision="prompt")

# --- Prompt: Git operations that change history or remotes ---
prefix_rule(pattern=["git", "rm"], decision="prompt")
prefix_rule(pattern=["git", "commit"], decision="prompt")
prefix_rule(pattern=["git", "push"], decision="prompt")

# Prompt on rewriting history / destructive cleanup.
prefix_rule(pattern=["git", "reset"], decision="prompt")
prefix_rule(pattern=["git", "rebase"], decision="prompt")
prefix_rule(pattern=["git", "clean"], decision="prompt")

# Prompt on force pushes explicitly (belt & suspenders).
prefix_rule(
  pattern=["git", "push"],
  decision="prompt",
  match=[" --force", " -f", "--force-with-lease"],
)

# --- Optional: forbid truly dangerous patterns ---
# If you never want the agent to do these automatically, flip to forbidden.
prefix_rule(pattern=["rm"], decision="forbidden", match=[" rm -rf /", " rm -rf /*", " rm -rf ~/"])